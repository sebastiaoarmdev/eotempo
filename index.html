<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="utf-8">
	<title>E o tempo?</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="E o tempo?">
	<link rel="icon" type="image/x-icon" href="./images/favicon.ico">
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
	body {
		font-family: monospace;
	}
	</style>
</head>
<body>
	<div id="root" class="flex flex-col items-center justify-center min-h-screen text-gray-700 p-6 bg-gradient-to-br from-pink-200 via-purple-200 to-indigo-200 ">
		<div class="w-full max-w-screen-sm bg-white p-6 rounded-xl ring-8 ring-white ring-opacity-40">
			<h1 class="text-6xl font-bold">E o tempo?</h1>
			<div class="leading-loose">
				<span class="border border-pink text-nowrap bg-indigo-200 p-0.5"><a href="./?woeid=455820">Belém, PA</a></span>
				<span class="border border-pink text-nowrap bg-indigo-200 p-0.5"><a href="./?woeid=455819">Brasília, DF</a></span>
				<span class="border border-pink text-nowrap bg-indigo-200 p-0.5"><a href="./?woeid=455830">Fortaleza, CE</a></span>
				<span class="border border-pink text-nowrap bg-indigo-200 p-0.5"><a href="./?woeid=455823">Porto Alegre, RS</a></span>
				<span class="border border-pink text-nowrap bg-indigo-200 p-0.5"><a href="./?woeid=455827">São Paulo, SP</a></span>
			</div>
			<div class="flex justify-between">
				<div id="current" class="flex flex-col">
					<span class="loading-signal hidden animate-spin text-9xl">•</span>
				</div>
				<div class="flex flex-col">
					<span class="mt-1">
						<img id="condition-slug" class="w-44 h-44">
					</span>
				</div>
			</div>
		</div>
		<div id="forecast" class="flex flex-col space-y-6 w-full max-w-screen-sm bg-white p-6 mt-10 rounded-xl ring-8 ring-white ring-opacity-40">
			<h2 class="text-xl font-bold">Previsões:</h2>
			<hr>
			<span class="loading-signal hidden animate-spin text-9xl">•</span>
		</div>
	</div>
	<script>
		'use strict';

		const urlParams = new URLSearchParams(location.search);
		const woeid = urlParams.get('woeid');
		const apiurl = (
			'https://api.hgbrasil.com/weather?format=json-cors&key=38c0fb37&' + (
				woeid ? `woeid=${woeid}` : 'user_ip=remote'
			)
		);
		const moonPhases = {
			'new': 'Lua nova',
			'waxing_crescent': 'Lua crescente',
			'first_quarter': 'Quarto crescente',
			'waxing_gibbous': 'Gibosa crescente',
			'full': 'Lua cheia',
			'waning_gibbous': 'Gibosa minguante',
			'last_quarter': 'Quarto minguante',
			'waning_crescent': 'Lua minguante'
		};
		const daysOfWeek = {
			'Dom': 'Domingo',
			'Seg': 'Segunda',
			'Ter': 'Terça',
			'Qua': 'Quarta',
			'Qui': 'Quinta',
			'Sex': 'Sexta',
			'Sáb': 'Sábado',
		};
		const currentDiv = document.getElementById('current');
		const forecastDiv = document.getElementById('forecast');
		const conditionSlugImg = document.getElementById('condition-slug');
		const loadingSignalSpans = document.getElementsByClassName('loading-signal');
		const cache = location.pathname + location.search;
		
		function secondsBetween(initialDate, finalDate) {
			const deltaInMiliseconds = (finalDate - initialDate);
			const deltaInSeconds = (deltaInMiliseconds / 1000);
			return deltaInSeconds;
		}
		
		function minutesBetween(initialDate, finalDate) {
			const deltaInSeconds = secondsBetween(initialDate, finalDate);
			const deltaInMinutes = (deltaInSeconds / 60);
			return deltaInMinutes;
		}
		
		function to24HourFormat(timeString) {
			const [time, period] = timeString.split(' ');
			const [hour, minute] = time.split(':');
			let formattedHour = (period === 'pm') ? (parseInt(hour) + 12) : hour;
			return formattedHour + ':' + minute;
		}
		
		function cacheIsValid() {
			const dataString = localStorage.getItem(cache);
			if (dataString === null) {
				console.log('Sem cachê!');
				return false;
			}
			console.log('Cachê existe.');
			const data = JSON.parse(dataString);
			const [lastSyncDay, lastSyncMonth, lastSyncYear] = (data.results.date).split('/');
			const [lastSyncHour, lastSyncMinute] = (data.results.time).split(':');
			const lastSyncDate = new Date(lastSyncYear, (lastSyncMonth - 1), lastSyncDay, lastSyncHour, lastSyncMinute);
			const lastRequestDate = new Date(data.got_at);
			const now = new Date();
			const minutesSinceLastSync = (minutesBetween(lastSyncDate, now));
			const minutesSinceLastRequest = (minutesBetween(lastRequestDate, now));
			console.log('Dados atualizados há', Math.floor(minutesSinceLastSync), 'minutos.');
			console.log('Dados recebidos há', Math.floor(minutesSinceLastRequest), 'minutos.');
			return ((minutesSinceLastSync < 60) || (minutesSinceLastRequest < 10));
		}
		
		async function getData(url) {
			console.log('Requisitando dados...');
			const response = await fetch(url);
			console.log('Dados recebidos!');
			const data = response.json();
			return data;
		}

		async function showData() {
			try {
				for (let loadingSignalSpan of loadingSignalSpans) {
					loadingSignalSpan.classList.remove('hidden');
				};
				let data;
				console.log('Cachê é válido?');
				if (cacheIsValid()) {
					console.log('Cachê é válido.');
					const dataString = localStorage.getItem(cache);
					data = JSON.parse(dataString);
				} else {
					console.log('Cachê não é válido.');
					data = await getData(apiurl);
					data.got_at = new Date();
					const dataToCache = JSON.stringify(data);
					console.log('Salvando cachê...');
					localStorage.setItem(cache, dataToCache);
					console.log('Cachê salvo.');
				}
				const currentData = data.results;
				const currentDataArray = [
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: currentData.city},
					{'class': 'text-nowrap text-xs font-semibold mt-1 text-gray-400', data: `${currentData.date} ${currentData.time}`},
					{'class': 'text-nowrap text-6xl font-bold', data: `${currentData.temp}°C`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• ${currentData.description}`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Umidade: ${currentData.humidity}%`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Nebulosidade: ${currentData.cloudiness}%`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Chuva na última 1h: ${currentData.rain}mm`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Amanhecer: ${to24HourFormat(currentData.sunrise)}`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Anoitecer: ${to24HourFormat(currentData.sunset)}`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• ${moonPhases[currentData.moon_phase]}`},
					{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Vento: ${currentData.wind_speedy} ${currentData.wind_direction}° ${currentData.wind_cardinal}`}
				];
				currentDataArray.forEach((element) => {
					const span = document.createElement('span');
					span.className = element.class;
					span.innerText = element.data;
					currentDiv.appendChild(span);
				});
				conditionSlugImg.setAttribute('src', `https://assets.hgbrasil.com/weather/icons/conditions/${currentData.condition_slug}.svg`);
				const forecastData = data.results.forecast;
				forecastData.forEach((element) => {					
					const forecastDataArray = [
						{'class': 'text-nowrap text-base font-bold', data: `${daysOfWeek[element.weekday]}, ${element.date}:`},
						{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• ${element.description}`},
						{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Mínima: ${element.min}°C`},
						{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Máxima: ${element.max}°C`},
						{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Nebulosidade: ${element.cloudiness}%`},
						{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Chuva esperada: ${element.rain}mm`},
						{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Chances de chuva: ${element.rain_probability}%`},
						{'class': 'text-nowrap font-semibold mt-1 text-gray-500', data: `• Vento: ${element.wind_speedy}`}
					];
					const columnsDiv = document.createElement('div');
					columnsDiv.classList.add('flex');
					columnsDiv.classList.add('justify-between');
					const textColumnDiv = document.createElement('div');
					textColumnDiv.classList.add('flex');
					textColumnDiv.classList.add('flex-col');
					const imageColumnDiv = document.createElement('div');
					imageColumnDiv.classList.add('flex');
					imageColumnDiv.classList.add('flex-col');
					const imageSpan = document.createElement('span');
					imageSpan.classList.add('mt-1');
					const imgTag = document.createElement('img');
					imgTag.setAttribute('src', `https://assets.hgbrasil.com/weather/icons/conditions/${element.condition}.svg`);
					imgTag.classList.add('w-44');
					imgTag.classList.add('h-44');
					forecastDiv.appendChild(columnsDiv);
					columnsDiv.appendChild(textColumnDiv);
					forecastDataArray.forEach((element) => {
						const span = document.createElement('span');
						span.className = element.class;
						span.innerText = element.data;
						textColumnDiv.appendChild(span);
					});
					columnsDiv.appendChild(imageColumnDiv);
					imageColumnDiv.appendChild(imageSpan);
					imageSpan.appendChild(imgTag);
				});				
				for (let loadingSignalSpan of loadingSignalSpans) {
					loadingSignalSpan.classList.add('hidden');
				};
			} catch (error) {
				console.error('Error!', error.message);
			}
		}
		
		showData();
	</script>
</body>
</html>
